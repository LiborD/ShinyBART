{
    "collab_server" : "",
    "contents" : "# ------------------------------\n#  BART TASK\n#  Originally developed by Lejuez et al. (2002). Evaluation of a behavioral measure of Risk taking...\n#  Implimented in Shiny by Nathaniel Phillips, http://ndphillips.github.io, Nathaniel.D.Phillips.is@gmail.com\n# ------------------------------\n\n# --------------------------\n# Load Libraries\n# --------------------------\nlibrary(shiny)\nlibrary(rdrop2)\n\n# --------------------------\n# Dropbox Parameters\n# --------------------------\n\n# You must have this file saved in your working directory\nEPtoken <- readRDS(\"EP_droptoken.rds\")          # Reads in authentication for EP dropbox\noutputDir <- \"nphillips/BART_A/data\"            # Determine dropbox output folder\n\n# --------------------------\n# Game Parameters\n# --------------------------\npop.max <- 50\npop.min <- 1\nballoons.n <- 10\npop.v <- sample(pop.min:pop.max, size = balloons.n, replace = TRUE)\n\n# --------------------------\n# User Interface\n# --------------------------\n\nui <- fixedPage(\n  \n  title = \"The Balloon Game\",\n  uiOutput(\"MainAction\"),\n  tags$style(type = \"text/css\", \".recalculating {opacity: 1.0;}\")   # Prevents gray screen during Sys.sleep()\n  \n)\n\n# --------------------------\n# Server\n# --------------------------\nserver <- function(input, output, session) {\n  \n\n# --------\n# Set up reactive values\n# These are objects that will change over the course of the game\n# ---------\n  \n# CurrentValues stores scalers representing the latest game outcomes\nCurrentValues <- reactiveValues(page = \"welcome\",\n                                balloon = 1,\n                                pumps = 0,\n                                pop = 0,\n                                saveballoon = 0,\n                                points.cum = 0)\n\n# GameValues stores vectors of histories\nGameData <- reactiveValues(balloon = c(),          \n                           time = c(),\n                           pumps = c(),\n                           action = c(),\n                           pop = c())\n  \n# --------\n# PageLayouts\n# ---------\n\n# Send dynamic UI to ui - DON'T CHANGE!\noutput$MainAction <- renderUI( {\n  PageLayouts()\n})\n\nPageLayouts <- reactive({\n    \n    # 1) WELCOME PAGE\n    if (CurrentValues$page == \"welcome\") {\n      \n      return(\n        list(\n          h1(\"Study Description\"),\n          p(\"This study will take place in two phases and should take between 5 and 10 minutes to complete.\"),\n          p(\"In Phase 1, you will play a game called 'The Balloon Game' and try to earn points while making risky decisions.\"),\n          p(\"In Phase 2, you will complete a few short questionnnaires about the game and how you make decisions in general.\"),\n          p(\"There are no health risks or personal identifying information associated with your participation.\"),\n          p(\"This study is founded by the chair of the department of Economic Psychology at the University of Basel.\"),\n          p(\"Your responses will be anonymous and in a group and your individual responses will not be published.\"),\n          p(\"If you consent to participating in this study, please enter a unique ID that no one else would use and click Continue.\"),\n          textInput(inputId = \"workerid\", \n                    label = \"Please enter a unique ID that no one else would use\", \n                    value = \"\", \n                    placeholder = \"e.g.; Cat57Door\"),\n          # This displays the action putton Next.\n          actionButton(inputId = \"gt_inst1\", \n                       label = \"Continue to Phase 1\") \n        )\n      )}\n  \n  \n  # 1) WELCOME PAGE\n  if (CurrentValues$page == \"inst1\") {\n    \n    return(\n      list(\n        h1(\"The Balloon Game\"),\n        p(\"In Phase 1 of this study, you will play The Balloon Game.\"),\n        p(\"Here's how The Balloon Game works. You will be presented with several deflated balloons. When you see a balloon, you can pump it by pressing a 'Pump' button. If you save a balloon before it pops, you will earn points. If you pops, you earn no points!\"),\n        p(\"For example, here is one deflated balloon. At the top of the screen you can see that this is balloon #1 and that you haven't pumped it.\"),\n        plotOutput(outputId = \"ss0np\"),\n        p(\"You can pump balloons by clicking the 'Pump' button below each balloon. Each time you pump a balloon, it will get a bit larger and has the potential to give you more points.\"),\n        p(\"To earn points, you need to SAVE a balloon before it pops! You can save a balloon at any time by clicking the 'Save' button. If you save a balloon, you will earn points equal to the number of pumps you put into it. You will then move on to the next balloon\"),\n        p(\"However -- if you pump a balloon too much it might pop! If a balloon pops, you cannot save it and will not earn any points for that balloon. You will then move on to the next balloon.\"),\n        p(paste(\"You will have the opportunity to pump\", balloons.n, \"balloons. Different balloons have different popping points and you never know exactly when each balloon will pop. However, you know for sure that the maximum possible number of pumps for a balloon is 100.\")),\n        h2(\"Examples\"),\n        p(\"For example, someone might pump a balloon 10 times. The balloon does not pop, and the player decides to 'Save'. Because the person Saved the balloon before it popped the person would earn 10 points for that balloon.\"),\n        plotOutput(outputId = \"ss10np\"),\n        p(\"However, someone else might pump the balloon 40 times, and then see that it pops on the 40th pump. Because the balloon popped, the person would not earn any points for this balloon\"),\n        plotOutput(outputId = \"ss40p\"),\n        p(\"As you can see, the more you pump a balloon the more risk you take. On the one hand, you might earn more points if the balloon does not pop. On the other hand, if the balloon does pop, you won't be ablew to save it and will not earn any points for that balloon.\"),\n        h2(paste(\"There will be\", balloons.n, \"balloons\")),\n        p(paste(\"You will play a total of\", balloons.n, \"balloons in this game. Again, different balloons have different popping points. You can never know for sure what the popping point for a balloon is unless it pops.\")),\n        p(paste(\"You can never lose points that you've earned after saving a balloon. Your goal is to earn as many points as you can across all\", balloons.n, \"balloons\")),\n        p(\"When you are ready to start, click Continue to start the first balloon!\"),\n        actionButton(inputId = \"gt_game\", \n                     label = \"Continue\") \n      )\n    )}\n  \n    \n    # 3) BALLOON PAGE\n    if (CurrentValues$page == \"game\") {\n      \n      if(CurrentValues$pop == 0 & CurrentValues$saveballoon == 0) {\n        \n        return(\n          list(\n            # Main Display: Contains both a pump and a save button\n            fixedRow(\n              column(12, \n                     plotOutput('BalloonDisplay'),\n                     # Buttons\n                     fixedRow(\n                       column(5,\n                              actionButton(\"pump\", label = \"Pump The Balloon\")),\n                       column(8,\n                              actionButton(\"saveballoon\", label = \"Save!\"))\n                     )))\n          )\n        )\n        \n      }\n      \n      if(CurrentValues$pop == 1) {\n        \n        return(\n          list(\n            # Pop Display: Only contains a \"Start next balloon\" button\n            fixedRow(\n              column(12,\n                     plotOutput('PopDisplay'),\n                     # Buttons\n                     fixedRow(\n                       column(1, offset = 5,\n                              actionButton(\"nextballoon\", \n                                           label = \"Start Next Balloon\"))\n                     )))\n          )\n        )\n      }\n      \n      if(CurrentValues$pop == 0 & CurrentValues$saveballoon == 1) {\n        \n        return(\n          list(\n            # Pop Display: Only contains a \"Start next balloon\" button\n            fixedRow(\n              column(12,\n                     plotOutput('SaveDisplay'),\n                     # Buttons\n                     fixedRow(\n                       column(1, offset = 5,\n                              actionButton(\"nextballoon\", \n                                           label = \"Start Next Balloon\"))\n                     )))\n          )\n        )\n      }\n      \n      \n    }\n    \n    # End of game\n    if (CurrentValues$page == \"gameend\") {\n      \n      return(list(h3(\"You finished the game!\"),\n                  p(paste(\"You earned\", CurrentValues$points, \"points in the game.\")),\n                  p(\"Please click continue to complete a short survey\"),\n                  actionButton(inputId = \"gt_surveyA\", \n                               label = \"Continue\")))\n    }\n    \n    # Post-game Survey A\n    if (CurrentValues$page == \"surveyA\") {\n      \n      return(list(\n        \n        h3(\"Survey (1 of 1)\"),\n        \n        radioButtons(\"sex\",\n                     label = \"What is your sex?\",\n                     choices = list(\"Male\" = 1, \"Female\" = 2, \"Other\" = 3),\n                     selected = 1),\n        \n        numericInput(\"age\", \n                     label = \"What is your age?\",\n                     value = 0),\n        \n        radioButtons(\"interesting\", \n                     label = \"How interesting did you find the Balloon Game?\",\n                     choices = c(\"1 - Not at all\" =  1,\n                                 \"2\" = 2,\n                                 \"3\" = 3,\n                                 \"4\" = 4,\n                                 \"5 - Very Much\" = 5\n                     )),\n        \n        textAreaInput(inputId = \"strategy\",\n                      label = \"What was your strategy in the Balloon Game?\",\n                      placeholder = \"I tried to...\", resize = \"both\"),\n        \n        radioButtons(\"playedbefore\", \n                     label = \"Have you played the balloon game before?\",\n                     choices = c(\"No, I have not played it.\" =  1,\n                                 \"Yes, I have played it.\" = 2,\n                                 \"I don't know\" = 3\n                     )),\n        \n        radioButtons(\"dontuse\",\n                     label = \"Is there any reason why we should NOT use your data for scientific research? For example, were you not paying attention or were you intoxicated?\",\n                     choices = c(\"No. My data should be valid for scientific research\" =  \"0\",\n                                 \"Yes. There is a good reason why you should NOT use my data for scientific research\" = 1\n                     )),\n        \n        textAreaInput(\"comments\",\n                      label = \"If you have any additional comments, please enter them below\",\n                      resize = \"both\"),\n        \n        actionButton(inputId = \"gt_goodbye\",\n                     label = \"Save Data and End Study\"))\n      )\n    }\n    \n    # 6) Goodbye\n    if (CurrentValues$page == \"goodbye\") {\n      \n      # CALCULATE COMPLETION CODE  \n      completion.code <- paste0(\"EP-BANDITA-\", sample(100:999, size = 1), \"-\", sample(100:999, size = 1), \"-\", sample(100:999, size = 1))\n      \n      return(list(\n        h3(\"Thank you for your participation!\"),\n        p(\"Here is your study completion code. Please write it down as a confirmation of your participation\"),\n        h2(completion.code),\n        h3(\"What was this research about?\"),\n        p(\"The purpose of this research is to try and understand how people learn and make decisions about risky options. The game you played is known as the Balloon Analogue Risk Task (BART). It is designed to measure how much risk people are willing to take when making decisions.\"),\n        p(\"If you have any questions about this study, you may contact us at EconPsychBasel@gmail.com. If you do contact us, please include your study completion code.\"),\n        p(\"You may close this window :)\"),\n        tags$img(src = \"thankyou.jpg\", width = \"300px\")\n      ))\n    }\n    \n  })\n  \n\n# -------------------\n# Bart game display\n# -------------------\n\nbart.display <- function(balloon, \n                         pumps, \n                         points.cum = 0,\n                         pop = FALSE,\n                         saveballoon = FALSE,\n                         balloons.n = 100,\n                         max.pumps = 100,\n                         show.max = TRUE,\n                         balloon.col = gray(.5, .5),\n                         pop.col = \"indianred1\",\n                         saveballoon.col = \"green3\") {\n  \n  # Plotting space\n  par(mar = c(0, 0, 0, 0))\n  layout(matrix(c(1, 2), nrow = 2, ncol = 1, byrow = TRUE), heights = c(4, 7), widths = c(9))\n  \n  # Title row\n  plot.new()\n  text(c(.1, .5, .9), c(.7, .7, .7), labels = c(\"Balloon\", \"Pumps\", \"Points\"), cex = 2, font = 3)\n  text(c(.1, .5, .9), c(.4, .4, .4), labels = c(paste(balloon, \"of\", balloons.n), pumps, points.cum), cex = 3)\n  \n  # text(c(.1, .5, .9), c(.5, .5, .5), labels = c(paste(balloon, \"of\", balloons.n), pumps, points.cum), cex = 3)\n\n  \n  par(mar = c(0, 0, 1, 0))\n  # Balloon display\n  plot(1, xlim = c(0, 1), ylim = c(0, 1), \n       type = \"n\", xaxt = \"n\", yaxt = \"n\", \n       bty = \"n\", xlab = \"\", ylab = \"\")\n  \n  if(show.max) {\n    \n    points(x = .5, y = .5, \n           cex = (max.pumps + 1) / 2.5, \n           pch = 1, col = gray(.3))\n  }\n  \n  if(pop == FALSE) {\n  \n  points(x = .5, \n         y = .5, \n         cex = (pumps + 1) / 2.5, \n         pch = 21, \n         bg = balloon.col, \n         col = \"black\")\n    \n  }\n  \n  if(pop == TRUE) {\n    \n    points(x = .5, \n           y = .5, \n           cex = (pumps + 1) / 2.5, \n           pch = 21, \n           bg = pop.col, \n           col = \"black\")\n    \n    mtext(text = \"POP!\", \n         cex = 5, side = 3, font = 3)\n    \n    # segments(.65, .40, .85, .4)\n    # segments(.65, .5, .85, .5)\n    \n    text(.8, .6, labels = paste(\"OUTCOME\\nThe balloon popped at pump\", pumps, \"\\nYou earned 0 points for this balloon\"), cex = 1.5, font = 3)\n    \n  }\n  \n  if(saveballoon == TRUE) {\n    \n    points(x = .5, \n           y = .5, \n           cex = (pumps + 1) / 2.5, \n           pch = 21, \n           bg = saveballoon.col, \n           col = \"black\")\n    \n    \n    text(.8, .6, labels = paste(\"OUTCOME\\nYou saved after\", pumps, \"pumps\\nYou earned\", pumps, \"points for this balloon\"), cex = 1.5, font = 3)\n    \n    \n  }\n  \n}\n\n\noutput$ss0np <- renderPlot({\n  \n  bart.display(balloon = 1,\n               balloons.n = balloons.n,\n               pumps = 0,\n               points.cum = 0,\n               max.pumps = pop.max,\n               pop = FALSE)\n  \n  text(.7, .85, labels = \"Deflated\\nBalloon\\n(0 Pumps)\", cex = 1.5, font = 3)\n  arrows(.65, .85, .51, .51, lty = 1, lwd = 1.5, col = gray(.2))\n  \n})\n\noutput$ss10np <- renderPlot({\n  \n  bart.display(balloon = 1,\n               balloons.n = balloons.n,\n               pumps = 10,\n               points.cum = 0,\n               max.pumps = pop.max,\n               pop = FALSE,\n               saveballoon = TRUE)\n  \n  \n  #text(.40, .9, labels = \"This person saveballoonped after 10 pumps\", cex = 1.5)\n#  arrows(.65, .85, .52, .55, lty = 1, lwd = 1.5, col = gray(.2))\n  \n})\n\noutput$ss40p <- renderPlot({\n  \n  bart.display(balloon = 5,\n               balloons.n = balloons.n,\n               points.cum = 0,\n               max.pumps = pop.max,\n               pumps = 40,\n               pop = TRUE)\n  \n # text(.40, .9, labels = \"This person popped the\\nBalloon at 40 Pumps\", cex = 1.5)\n # arrows(.65, .85, .6, .7, lty = 1, lwd = 1.5, col = gray(.2))\n  \n})\n\n# -------------------\n# Define buttons \n# -------------------\n  \n# Starting game display\nobserveEvent({input$gt_game}, {\n  \n  output$BalloonDisplay <- renderPlot({\n    \n    bart.display(balloon = CurrentValues$balloon,\n                 pumps = CurrentValues$pumps,\n                 balloons.n = balloons.n,\n                 max.pumps = pop.max,\n                 points.cum = CurrentValues$points.cum,\n                 pop = FALSE)\n    \n  })\n})\n\n# Pump button\nobserveEvent({input$pump}, {\n  \n  # Balloon does NOT Pop\n  if(CurrentValues$pumps < pop.v[CurrentValues$balloon]) {\n    \n    CurrentValues$pumps <- CurrentValues$pumps + 1\n    \n    GameData$balloon <- c(GameData$balloon, CurrentValues$balloon)\n    GameData$time <- c(GameData$time, proc.time()[3])\n    GameData$pumps <- c(GameData$pumps, CurrentValues$pumps)\n    GameData$action <- c(GameData$action, 1)\n    GameData$pop <- c(GameData$pop, 0)\n    \n    # No pop display\n    output$BalloonDisplay <- renderPlot({\n      \n      bart.display(balloon = CurrentValues$balloon,\n                   pump = CurrentValues$pumps,\n                   balloons.n = balloons.n,\n                   max.pumps = pop.max,\n                   points.cum = CurrentValues$points.cum,\n                   pop = FALSE,\n                   saveballoon = FALSE)\n      \n    })\n    \n  }\n  \n  # Balloon DOES Pop\n  if(CurrentValues$pumps >= pop.v[CurrentValues$balloon]) {\n    \n    # Pop Display\n    output$PopDisplay <- renderPlot({\n      \n      bart.display(balloon = CurrentValues$balloon,\n                   pump = CurrentValues$pumps,\n                   points.cum = CurrentValues$points.cum,\n                   balloons.n = balloons.n,\n                   max.pumps = pop.max,\n                   pop = TRUE,\n                   saveballoon = FALSE)\n      \n    })\n    \n    CurrentValues$pop <- 1\n    \n    GameData$balloon <- c(GameData$balloon, CurrentValues$balloon)\n    GameData$time <- c(GameData$time, proc.time()[3])\n    GameData$pumps <- c(GameData$pumps, CurrentValues$pumps)\n    GameData$action <- c(GameData$action, 1)\n    GameData$pop <- c(GameData$pop, 1)\n    \n  } \n  \n  \n})\n\n# saveballoon button\nobserveEvent(input$saveballoon, {\n  \n  # Pop Display\n  output$SaveDisplay <- renderPlot({\n    \n    bart.display(balloon = CurrentValues$balloon,\n                 pump = CurrentValues$pumps,\n                 balloons.n = balloons.n,\n                 max.pumps = pop.max,\n                 points.cum = CurrentValues$points.cum,\n                 pop = FALSE,\n                 saveballoon = TRUE)\n    \n  })\n  \n  GameData$balloon <- c(GameData$balloon, CurrentValues$balloon)\n  GameData$time <- c(GameData$time, proc.time()[3])\n  GameData$pumps <- c(GameData$pumps, NA)\n  GameData$action <- c(GameData$action, 0)\n  GameData$pop <- c(GameData$pop, 0)\n  \n  # Add points for current balloon to point total\n  CurrentValues$points.cum <- CurrentValues$points.cum + CurrentValues$pumps\n  CurrentValues$saveballoon <- 1\n\n})\n\n# After a pop, start next balloon\nobserveEvent({input$nextballoon}, {\n    \n    CurrentValues$pumps <- 0\n    CurrentValues$pop <- 0\n    CurrentValues$balloon <- CurrentValues$balloon + 1\n    CurrentValues$saveballoon <- 0\n    \n  })\n\n# Look for final balloon -> Go to gameend\nobserveEvent({CurrentValues$balloon}, {\n  \n  if(CurrentValues$balloon > balloons.n) {\n    \n    CurrentValues$page <- \"gameend\"\n    \n  }\n  \n})\n  \n# Page navigation buttons\nobserveEvent(input$gt_inst1, {CurrentValues$page <- \"inst1\"})\nobserveEvent(input$gt_game, {CurrentValues$page <- \"game\"})\nobserveEvent(input$gt_surveyA, {CurrentValues$page <- \"surveyA\"})\nobserveEvent(input$gt_goodbye, {CurrentValues$page <- \"goodbye\"})\n  \n# Saving data\nobserveEvent(input$gt_goodbye, {\n  \n  # Create progress message   \n  withProgress(message = \"Saving data...\", \n               value = 0, {\n                 \n                 incProgress(.25)\n                 \n                 # Write GameData to a dataframe\n                 GameData.i <- data.frame(\"balloon\" = GameData$balloon,\n                                          \"time\" = GameData$time,\n                                          \"action\" = GameData$action, \n                                          \"pop\" = GameData$pop)\n                 \n                 \n                 incProgress(.5)\n                 \n                 GameDatafileName <- paste0(input$workerid, as.integer(Sys.time()), digest::digest(GameData.i), \"_g.csv\")\n                 GameDatafilePath <- file.path(tempdir(), GameDatafileName)\n                 write.csv(GameData.i, GameDatafilePath, row.names = FALSE, quote = TRUE)\n                 rdrop2::drop_upload(GameDatafilePath, \n                                     dest = outputDir, \n                                     dtoken = EPtoken)\n                 \n                 # # Write survey data \n                 # SurveyDatafileName <- paste0(input$workerid, as.integer(Sys.time()), digest::digest(SurveyData.i), \"_s.csv\")\n                 # SurveyDatafilePath <- file.path(tempdir(), SurveyDatafileName)\n                 # write.csv(SurveyData.i, SurveyDatafilePath, row.names = FALSE, quote = TRUE)\n                 # rdrop2::drop_upload(SurveyDatafilePath, dest = outputDir, dtoken = EPtoken)\n                 # \n                 incProgress(.40)\n                 \n                 # Some interesting plots (not necessary)\n                 \n                 output$GameData.tbl <- renderTable(GameData.i)         \n                 output$earnings <- renderPlot({\n                   \n                   plot(x = GameData.i$trial, \n                        y = cumsum(GameData.i$outcome), \n                        type = \"b\", \n                        xlab = \"Trial\", \n                        ylab = \"Points\")\n                   \n                 }) \n                 \n                 CurrentValues$page <- \"goodbye\"\n                 Sys.sleep(.25)\n                 incProgress(1)\n                 \n               })\n  \n})\n  \n}\n\n# Create app!\nshinyApp(ui = ui, server = server)",
    "created" : 1484667018301.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "4010745906",
    "id" : "A0CCB5EA",
    "lastKnownWriteTime" : 1484732432,
    "last_content_update" : 1484732432502,
    "path" : "~/Dropbox/rprojects/ShinyPsych/ShinyBART/ShinyBART_app.R",
    "project_path" : "ShinyBART_app.R",
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}